# 零成本搭建个人博客网站



使用VuePress+GithubPage**一块钱**搭建自己的个人博客网站

环境准备

1. Node
2. Chrome浏览器或FireFox浏览器
3. 一台电脑（Windows）
4. 1RMB



本文主要参考：

[从零开始搭建博客系列 | 从 01 开始](https://www.peterjxl.com/Blog/Introduce/#本系列讲什么)

[VuePress 博客搭建系列 33 篇正式完结！ · Issue #279 · mqyqingfeng/Blog · GitHub](https://github.com/mqyqingfeng/Blog/issues/279)



# 从零开始搭建博客

## 本地搭建

1. 创建并进入一个新目录

​		在命令行中创建并进入新目录 `vuepress-starter`（可以自定义名字）：

```shell
cd vuepress-starter
```

2. 使用npm（node包管理器）进行初始化（-y可以自动确认问题）

```shell
npm init  -y
```

3. 将 VuePress 安装为本地依赖

```shell
 npm install -D vuepress
```

4. 创建你的第一篇文档

   VuePress 会以 docs 为文档根目录，所以README.md 相当于主页：

​		创建 `docs` 目录，并在其中创建 `README.md` 文件作为首页内容：

```shell
mkdir docs
echo '# Hello VuePress' > docs/README.md
```

5. 修改 package.json 文件，添加一些启动命令：

```json
  "scripts": {
    "docs:dev": "vuepress dev docs",
    "docs:build": "vuepress build docs"
  }
```

- 这样做的好处是你可以通过简单的命令来运行开发服务器或构建生产版本的静态文件，比如：

  - 启动本地开发服务器：`npm run docs:dev`

  - 构建用于部署的静态文件：`npm run docs:build`

6. 测试本地环境

```shell
npm run docs:dev
```

7. 运行编译成功后，会有提示：

![image-20250116215750272](https://img.cyanyep.top/picture/image-20250116215750272.png)

8. 在浏览器打开这个shell窗口中的网址 `http://localhost:8081`（默认端口是8080，可能我的端口被占用了），可以看到如下内容：

![image-20250116220142153](https://img.cyanyep.top/picture/image-20250116220142153.png)



## 优化

都是一些没有的，做不做无所谓



### 配置首页

现在的页面太简单了，我们可以对项目首页进行配置，修改 docs/README.md ：

```yaml
home: true
heroImage: https://s3.bmp.ovh/imgs/2022/12/02/bc7428e3916c3a4c.jpg
heroText: Hero标题
tagline: Hero副标题
actionText: 快速上手→
actionLink: /README.md
features:

- title: 简洁至上
  details: 以Markdown为中心的项目结构，以最少的配置帮助你专注于写作。
- title: Vue驱动
  details: 享受Vue+ webpack 的开发体验，在Markdown中使用Vue组件，同时可以使用Vue来开发自定义主题。
- title: 高性能
  details: VuePress为每个页面预渲染生成静态的 HTML，同时在页面被加载的时候，将作为 SPA 运行。
  footer: 粤ICP备2022067627号-1  粤公网安备 44011302003646号
```

以上内容使用 yaml 语法，读者修改的时候注意不要违反了 yaml 语法规则。



### 热更新

什么是热更新：如果我们已经运行了本项目，在我们修改文档时候，VuePress 能自动更新博客，不用重新运行也能看到修改后的博客的内容（相当于会自动编译运行，不用我们手工编译运行了）。

VuePress 本身是支持热更新的，但是有 bug……有时候会热更新失败

因此，想要做到热更新，得修改下命令，添加一个临时目录：

```json
"docs:dev": "vuepress dev docs --temp .temp"
```

由于该临时目录只用于解决热更新失败的问题，我们在 `.gitignore` 也添加一条忽略的规则：

```.gitignore
.temp
```

注意，我们修改了 package.json 文件，得重新运行本项目。

在后续的使用过程中，一般文档内容等会自动更新，但如果有修改什么配置文件，可能得重启；



### 导航栏配置

接下来我们来配置下导航栏。

新建 docs/.vuepress/config.js 配置文件，文件内容如下：

```yml
module.exports = {
  title: 'TypeScript4 文档',
  description: 'TypeScript4 最新官方文档翻译',
  head: [
    ['link', { rel: 'icon', href: 'https://s3.bmp.ovh/imgs/2023/02/15/16aa54f3ee84602e.webp' }]
  ],
  themeConfig: {
  	subSidebar: 'auto',
    logo: 'https://s3.bmp.ovh/imgs/2022/12/02/bc7428e3916c3a4c.jpg',
    nav: [
      { text: '首页', link: '/' },
      { 
          text: '西螈的 JavaScript 博客', 
          items: [
              { text: 'Github', link: 'https://github.com/rc4gyyc' },
              { text: 'CSDN', link: 'https://blog.csdn.net/rc4gyyc' }
          ]
      }
    ]
  }
}
```



### 静态资源

有时候，一些图片是经常被用到的，我们可以将其放到一个公共文件夹里，这样就可以在不同的博客里都引用到了。

我们在 .vuepress 目录下新建 public 目录，然后放一个图片，例如 amiliya.jpg。此时文件夹目录结构如下：

```
vuepress-learn
├── .temp
├── docs
│   ├── .vuepress
│   │   ├── public
│   │   │   └── amiliya.jpg
│   │   └── config.js
│   ├── Basic
│   │   ├── Basic1.md
│   │   └── Basic2.md
│   ├── Java
│   │   ├── JavaEE.md
│   │   └── JavaSE.md
│   └── README.md
├── package-lock.json
└── package.json
```



然后我们就可以在博客或配置文件里引用了。例如在 Basic1.md 里引用：

```markdown
# Basic1

![](/amiliya.jpg)

这里是计算机基础第一课！
```



又或者在配置文件里访问图片：



```ts
module.exports = {
  themeConfig: {
    logo: '/re0.jpg',
  }
}
```

 

## 主题

我们之前想要增加侧边栏，需要一个个配置链接，才能让侧边栏展示成我们想要的效果，非常麻烦；有时候我们还想要加载 loading、切换动画、返回顶部、评论等功能，都自己开发的话太麻烦了。

本博客就是使用了 [vdoing 主题 (opens new window)](https://doc.xugaoyi.com/)，能自动生成侧边栏、标题和目录页等等功能，非常方便。本文就以 vdoing 主题为例，演示如何使用一个主题（建议读者先简单看一下该主题的文档，或者等看完本博客后再看也行）。



### 博客准备

由于 vdoing 主题对于 Markdown 文件和文件夹的命名有要求（需要在其前面用梳子编号），我们同步修改下。修改后目录结果如下：

```js
vuepress-learn
├── docs
│   ├── .vuepress
│   │   ├── public
│   │   │   └── amiliya.jpg
│   │   └── config.js
│   ├── 01.Basic
│   │   ├── 01.Basic1.md
│   │   └── 02.Basic2.md
│   ├── 02.Java
│   │   ├── 01.JavaEE.md
│   │   └── 02.JavaSE.md
│   └── README.md
├── package-lock.json
└── package.json
```



### 安装

其实主题也就是一个 npm 包，可以通过 npm 的方式下载。

```shell
npm install vuepress-theme-vdoing -D
```

在 config.js 里配置使用主题（第 6 行）：

```yml
module.exports = {
  title: 'TypeScript4 文档',
  description: 'TypeScript4 最新官方文档翻译',
  head: [
    ['link', { rel: 'icon', href: 'https://s3.bmp.ovh/imgs/2023/02/15/16aa54f3ee84602e.webp' }]
  ],
  base: '/',
  theme: 'vdoing', 
  locales: {
    '/': {
      lang: 'zh-CN'
    }
  },
  themeConfig: {
    logo: 'https://s3.bmp.ovh/imgs/2022/12/02/bc7428e3916c3a4c.jpg',
    nav: [
      { text: '首页', link: '/' },
      { 
          text: '西螈的 JavaScript 博客', 
          items: [
              { text: 'Github', link: 'https://github.com/rc4gyyc' },
              { text: 'CSDN', link: 'https://blog.csdn.net/rc4gyyc' }
          ]
      }
    ],
    sidebar: 'structuring'
  }
}
```





## 部署

我们的博客就算是正式的做好了，接下来我们部署到免费的 Github Pages 上。我们在 Github 上新建一个仓库，这里我取得仓库名为：`cyanyep`。

对应，我们需要在 `config.js` 添加一个 `base` 路径配置：

```ts
module.exports = {
  	// 路径名为 "/<REPO>/"
    base: '/cyanyep/',
  	//...
}
```

最终的 `config.js` 文件内容为：

```ts
module.exports = {
  title: 'TypeScript4 文档',
  description: 'TypeScript4 最新官方文档翻译',
  head: [
    ['link', { rel: 'icon', href: 'https://s3.bmp.ovh/imgs/2023/02/15/16aa54f3ee84602e.webp' }]
  ],
  base: '/cyanyep/',
  theme: 'vdoing', 
  locales: {
    '/': {
      lang: 'zh-CN'
    }
  },
  themeConfig: {
	subSidebar: 'auto',
    logo: 'https://s3.bmp.ovh/imgs/2022/12/02/bc7428e3916c3a4c.jpg',
      nav: [
        { text: '首页', link: '/' },
        { 
            text: '西螈的 JavaScript 博客', 
            items: [
                { text: 'Github', link: 'https://github.com/rc4gyyc' },
                { text: 'CSDN', link: 'https://blog.csdn.net/rc4gyyc' }
            ]
        }
      ],
      sidebar: [
        {
            title: '欢迎学习',
            path: '/',
            collapsable: false, // 不折叠
            children: [
                { title: "学前必读", path: "/" }
            ]
        },
        {
          title: "个人博客网站搭建",
          path: '/Blog/build',
          collapsable: false, // 不折叠
          children: [
            { title: "搭建个人博客网站", 
              author: "西螈", 
              date: "2024-12-12", 
              path: "/Blog/build" }
          ],
        }
      ]
    }
}
```



然后我们在项目 `vuepress-starter` 目录下建立一个脚本文件：`deploy.sh`，注意修改一下对应的用户名和仓库名：

```sh
#!/usr/bin/env sh

# 确保脚本抛出遇到的错误
set -e

# 生成静态文件
npm run docs:build

# 进入生成的文件夹
cd docs/.vuepress/dist

cp -r ../../../.github ./

git init
git add -A
git commit -m 'deploy'

# 如果发布到 https://<USERNAME>.github.io/<REPO>
git push -f git@github.com:rc4gyyc/cyanyep.git master:cy-pages

cd -
```

然后命令行切换到 `vuepress-starter` 目录下，执行 `sh deploy.sh`，就会开始构建，然后提交到远程仓库，注意这里提交到了 `cy-pages` 分支，我们查看下对应仓库分支的代码：

我们可以在仓库的 `Settings -> Pages` 中看到最后的地址：`rc4gyyc.github.io/cyanyep`



至此，我们完成了 VuePress 和 Github Pages 的部署。

你就可以使用你的最基本的个人博客网站。

---

参考：







# 域名

## 购买域名

如果是新用户，可以在阿里云购买域名，一些域名首年只需要1元， 使用你仅有的一块钱买它

购买域名后，可以设置域名解析，通过你购买的域名解析到你的个人博客网页xxx.github.io。

![image-20250327175501771](https://img.cyanyep.top/picture/image-20250327175501771.png)

## 域名解析

在github设置的setting->pages中设置你的域名

![image-20250327202925641](https://img.cyanyep.top/picture/image-20250327202925641.png)

在阿里云中设置解析到你的gitHub.io

![image-20250327182538105](https://img.cyanyep.top/picture/image-20250327182538105.png)

就可以通过你的域名cyanyep.top访问github.io了



- 访问你的域名后会发现css样式没了

![](https://img.cyanyep.top/picture/image-20250327205312348.png)

这是因为之前 GitHub Pages 将项目部署在子路径 `https://rc4gyyc.github.io/cyanyep/`下。

而我们设置的config.ts文件中 VuePress 是根据网站部署在 /cyanyep/ 目录下设置页面的，

所以需要**修改config.ts文件的base路径配置：将原来的/cyanyep/ 改为 /**

```ts
module.exports = {
  	// 路径名为 "/<REPO>/"
    base: '/',
  	//...
}
```



## 域名解析完善

我们在setting->pages->custom domain设置的自定义域名.

- 本质上是在我们的page分支`cy-pages`中创建CNAME文件，并在文件中添加我们的域名`cyanyep.top`

- 而我们每次执行构建命令`npm run docs:build`时，都是重新构建项目并生成dist文件夹，然后推送到github上，Github Pages会根据dist文件夹中的内容构建页面，每次dist文件夹和远程分支cy-pages都会被覆盖，
- 所以我们可以先创建好CNAME文件，然后通过`deploy.sh`脚本将文件放在dist文件夹中



# 图床

参考视频：[十分钟搭建你自己的图床，手把手教你，免费，picgo, 七牛云](https://www.bilibili.com/video/BV1fw411t7eU/)

在七牛云中的存储对象中新建空间



## 图片上传工具

我的博客是基于 Markdown 的，如果我们每次上传图片都需要登录到七牛云控制台并上传，就太慢了。因此市面上出现了很多图片上传工具，能实现的效果是这样的：将图片拖拽到工具里，就能自动上传到对象存储里，并且获取图片链接，极大简化了我们的操作。

我使用的工具是：

- [PicGo ](https://molunerfinn.com/PicGo/)：支持 Windows，Mac 和 Linux，基于 Electron 开发，支持多种图床上传



‍[github.com/NothingMeaning/foureggs (opens new window)](https://github.com/NothingMeaning/foureggs)：博主目前在用的，直接在 Markdown 文件上右键即可上传，并自动替换原始文件里的图片链接，不过会生成一个新的Markdown文件，非常方便。

该工具有安装包和源码，源码里有可运行的exe文件，如果使用源码可以自己[将工具注册到右键中](https://www.bilibili.com/video/BV1S64y1G76f/)



## 为图床设置自己的域名

**七牛云给的免费访问域名**是用于测试的，有有效期，想要长期使用还需要用自己的域名



而且七牛云图床免费域名的使用的是**http协议**，不能用于https的网站（比如GitHub Page），会导致图片加载不出。

需要用自己域名和证书

可以在阿里云购买域名，**使用阿里云免费证书**，就供个人网站、测试用。每年有20个证书额度，一个证书可以用三个月



### 添加子域名

在阿里云云中添加一个新的子域名，用于博客网站访问我们的图床

- 解析记录类型选**CNAME**，
- 主机记录就是访问图床时的子域名
- **记录值等下还要再改，先随便填**

![image-20250327195035760](https://img.cyanyep.top/picture/image-20250327195035760.png)



### 将阿里云的证书添加到七牛云

参考视频：[wordpress 极速搭建个人独立博客 014七牛云上传阿里云SSL证书](https://www.bilibili.com/video/BV1i4411s72P/)



在阿里云中搜索ssl证书。

在**个人测试证书**中**立即购买**，可以购买免费的证书，每年可以有20个额度，

购买后**创建证书**，输入刚刚创建的**子域名**img.cyanyep.top，并输入个人信息进行验证就可以了

![image-20250327182639386](https://img.cyanyep.top/picture/image-20250327182639386.png)



创建证书后在更多里找到下载，下载证书，服务器类型为其他

![image-20250327190139813](https://img.cyanyep.top/picture/image-20250327190139813.png)



点击绑定域名可以跳转到添加域名中

![image-20250327191122830](https://img.cyanyep.top/picture/image-20250327191122830.png)



在SSL 证书服务中上传自有证书

- 证书备注名：随便填，可以填你的域名
- 证书内容（PEM 格式）：上传 下载的zip中 .pem后缀的文件
- 证书私钥（PEM 格式）：上传 下载的zip中 .key后缀的文件

![image-20250327193656277](https://img.cyanyep.top/picture/image-20250327193656277.png)



### 在七牛云添加域名

- 输入刚刚创建的子域名

- 选择https和刚刚上传的证书

- 使用场景：图片小文件

- 缓存配置：使用推荐配置

- 其他不用修改

- 点击创建

![image-20250327201600024](https://img.cyanyep.top/picture/image-20250327201600024.png)



#### 验证域名所有权

![image-20250327201659604](https://img.cyanyep.top/picture/image-20250327201659604.png)

根据图片在阿里云添加域名解析，

- 记录类型：txt

- 主机记录：verification

- 记录值：填你自己生成的

![image-20250327201721567](https://img.cyanyep.top/picture/image-20250327201721567.png)



### 将子域名解析到七牛云

添加后回到七牛云**点击验证**，验证后会给你一个**CNAME**，将其配置到刚刚创建的子域名img.cyanyep.top的**记录值**中。

这样你的子域名就会解析到七牛云的域名，可以通过你的子域名访问图片

![image-20250327201838662](https://img.cyanyep.top/picture/image-20250327201838662.png)

![image-20250327201858912](https://img.cyanyep.top/picture/image-20250327201858912.png)

等待片刻就会发邮箱通知你加速域名创建成功

修改你的外链域名就可以用你的子域名访问图片了

![image-20250327202228150](https://img.cyanyep.top/picture/image-20250327202228150.png)



---

参考：

[十分钟搭建你自己的图床，手把手教你，免费，picgo, 七牛云](https://www.bilibili.com/video/BV1fw411t7eU/)

[wordpress 极速搭建个人独立博客 014七牛云上传阿里云SSL证书](https://www.bilibili.com/video/BV1i4411s72P/)

[将工具注册到右键中](https://www.bilibili.com/video/BV1S64y1G76f/)





# 同步GitHub和Gitee

参考：[一篇教你代码同步 Github 和 Gitee](https://github.com/mqyqingfeng/Blog/issues/236) 



我们成功的用 VuePress 搭建了博客并部署到 Github Pages，但由于 Github 的访问问题，我们可以选择把仓库部署到 Gitee 一份，利用 Gitee 的 Pages 服务再生成一份静态网站用于备用（**gitee Pages目前停止服务**），不过也可以作为一个备份

## 1. 手动同步

在 Gitee 绑定 Github 账号后，选择仓库导入：

在 Gitee 的项目主页，提供了同步的按钮，你只用点一下，即可与 Github 同步更新，但是注意这里的同步功能默认是强制同步。

## 2. 推送两个仓库

除此之外，我们也可以在 sh 脚本文件里，直接将项目同时推送到两个仓库地址上，具体操作参考[《一篇教你代码同步 Github 和 Gitee》](https://github.com/mqyqingfeng/Blog/issues/236) 

## 3. Github Actions 自动同步（推荐使用）

我们也可以利用 Github Actions，写一个工作流，在发现 Github 博客仓库的 gh-pages 分支代码更新后，自动同步当前代码到 Gitee 上。

关于 Github Actions 的介绍，可以参考阮一峰老师的 [《GitHub Actions 入门教程》](http://www.ruanyifeng.com/blog/2019/09/getting-started-with-github-actions.html)

为了实现 Gitee 和 Github 的同步，我们需要借助一个 action，还好业界已经有现成的实现了，这里我采用的是 [Hub Mirror Action](https://github.com/Yikun/hub-mirror-action)，我们可以看到使用的示例代码：

```yml
steps:
- name: Mirror the Github organization repos to Gitee.
  uses: Yikun/hub-mirror-action@master
  with:
    src: github/rc4gyyc
    dst: gitee/ciian
    dst_key: ${{ secrets.GITEE_PRIVATE_KEY }}
    dst_token: ${{ secrets.GITEE_TOKEN }}
```

其中有四个必填项：

- `src` 表示需要被同步的源端账户名，即我们 Github 的账户名，因为我的 Github ID 是 rc4gyyc，所以这里我应该改成 `github/rc4gyyc`。
- `dst` 表示需要同步到的目的端账户名，即我们 Gitee 的账户名，因为我的 Gitee ID 是 ciian，所以这里我应该改成 `gitee/ciian`。
- `dst_key` 表示用于在目的端上传代码的私钥，然后将其保存在 Secrets 中。

### 同步仓库具体操作

1. 注意gitee上同时要配置好公钥，在setting->ssh公钥中配置
2. 获取你电脑上的ssh私钥（在git命令行中执行、或者直接访问文件）：`cat ~/.ssh/id_rsa`
   - 复制私钥内容（注意要全部复制包括

​			-----BEGIN OPENSSH PRIVATE KEY-----
​			-----END OPENSSH PRIVATE KEY-----

​			），然后在要**同步的 Github 仓库**中，选择 "Setting" -> "Secrets" ->"Action" -> "New repository secret"

​			填入 Secret 内容，Name 命名为 "GITEE_PRIVATE_KEY"，Value 为复制的内容

![image-20250327100809374](https://img.cyanyep.top/picture/image-20250327100809374.png)

3. dst_token 创建仓库的API tokens， 用于自动创建不存在的仓库。这里我们从 Gitee 上获取，具体地址为 https://gitee.com/profile/personal_access_tokens。生成并复制 Token，然后同样的步骤，保存在 Github 的 Secrets 中，Name 为 "GITEE_TOKEN"

4. 然后我们就可以在项目根目录(vuepress-starter)下建立目录 `.github/workflows` ，然后创建一个名为`syncToGitee.yml` 的文件：

```yml
name: syncToGitee
on:
  push:
    branches:
      - cy-pages
jobs:
  repo-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Mirror the Github organization repos to Gitee.
        uses: Yikun/hub-mirror-action@master
        with:
          src: 'github/rc4gyyc'
          dst: 'gitee/ciian'
          dst_key: ${{ secrets.GITEE_PRIVATE_KEY }}
          dst_token:  ${{ secrets.GITEE_TOKEN }}
          static_list: "cyanyep"
          force_update: true
          debug: true
```

还有几个问题要注意：

- on: push: branches: 就是当cy-pages分支发生事件推送时，GitHub Actions 会检查该分支当前提交中是否存在对应的 YAML 文件。所以我们需要将syncToGitee.yml文件放在cy-pages分支下
- 观察我们的脚本代码，我们就会发现，每次我们 `sh deploy.sh` 的时候，都是编译代码到 dist 目录，然后重新 git init ，最后强制提交。就是说dist目录才是要提交到分支上的，而且每次运行都会清空dist重新编译，本地仓库也会重新初始化后再强制推送上去覆盖原来的分支，也就是说不能直接把脚本放在git仓库的cy-pages分支中

5. 为此，我们可以在脚本里添加代码，每次编译完后，再拷贝外层的 `.github/woorkflows/syncToGitee.yml` 到 dist 目录里，再提交到 Github 上。

所以我们依然在项目根目录添加目录和文件，此时的文件结构如下：

```
.
├─ docs
│  ├─ README.md
│  └─ .vuepress
│     └─ config.js
└─ .github
│  └─ workflows
│			└─ syncToGitee.yml
└─ package.json
└─ deploy.sh
```

脚本文件`deploy.sh`代码如下：

```
#!/usr/bin/env sh

# 确保脚本抛出遇到的错误
set -e

# 生成静态文件
npm run docs:build

# 进入生成的文件夹
cd docs/.vuepress/dist

###添加###
# 拷贝目录和文件
cp -r ../../../.github ./

git init
git add -A
git commit -m 'deploy'

# 如果发布到 https://<USERNAME>.github.io/<REPO>
git push -f git@github.com:rc4gyyc/cyanyep.git master:cy-pages

cd -
```

此时我们再运行 `sh deploy.sh` 代码提交到 Github，就可以在仓库的 Actions 中看到运行记录：



### Gitee 自动部署 Pages（Gitee Pages目前停止服务，以下操作已无效）

参考：[Gitee 如何自动部署 Pages？还是用 GitHub Actions!](https://github.com/mqyqingfeng/Blog/issues/238)

在syncToGitee文件中补充代码

- 可以在仓库的secret中设置gitee用户名

```yml
name: syncToGitee
on:
  push:
    branches:
      - cy-pages
jobs:
  repo-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Mirror the Github organization repos to Gitee.
        uses: Yikun/hub-mirror-action@master
        with:
          src: 'github/rc4gyyc'
          dst: 'gitee/ciian'
          dst_key: ${{ secrets.GITEE_PRIVATE_KEY }}
          dst_token:  ${{ secrets.GITEE_TOKEN }}
          static_list: "cyanyep"
          force_update: true
          debug: true
          
      # - name: Build Gitee Pages
      #   uses: yanglbme/gitee-pages-action@main
      #   with:
      #     # 注意替换为你的 Gitee 用户名
      #     gitee-username: ${{ secrets.GITEE_USERNAME }}
      #     # 注意在 Settings->Secrets 配置 GITEE_PASSWORD
      #     gitee-password: ${{ secrets.GITEE_PASSWORD }}
      #     # 注意替换为你的 Gitee 仓库，仓库名严格区分大小写，请准确填写，否则会出错
      #     gitee-repo: Ciian/cyanyep
      #     # 要部署的分支，默认是 master，若是其他分支，则需要指定（指定的分支必须存在）
      #     branch: cy-pages
```

- 注意**用户名和仓库名**都区分大小写



---

参考：

[《一篇教你代码同步 Github 和 Gitee》](https://github.com/mqyqingfeng/Blog/issues/236) 

 [《GitHub Actions 入门教程》](http://www.ruanyifeng.com/blog/2019/09/getting-started-with-github-actions.html)

[Gitee 如何自动部署 Pages？还是用 GitHub Actions!](https://github.com/mqyqingfeng/Blog/issues/238)



# 自动部署



## 通过Github Action自动构建并部署项目

每次修改博客后都需要执行脚本deploy.sh，重新构建才能上传的github。

了解到GitHub的Action后，我想是否可以直接把整个项目上传到github的一个分支`pages-code`（从main分支新建一个分支）上，再通过workflow自动将项目的代码构建并部署到指定GitHub Page的分支`cy-pages`上，(如果有自己的服务器也可以部署到服务器上，可以参考[这篇文章](https://www.peterjxl.com/Blog/Deploy/#%E4%BD%BF%E7%94%A8-github-action))

而且如果Action执行失败还会发qq邮箱通知，不用担心构建失败不知道。

1. 在项目根目录创建文件.gitignore，推送时忽略node_modules目录，因为node_modules是一些三方依赖很大，而且可以在workflow中安装

   ```.gitignore
   node_modules/
   ```

2. 仍然在.github/woorkflows/目录中创建新的workflow脚本deploy.yml

```yml
name: Deploy VuePress to GitHub Pages
# 当 pages-code 分支有 push 事件时触发
on:
  push:
    branches:
      - pages-code
      
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 检出代码
      - uses: actions/checkout@v3

      # 使用action库，安装node
      - name: Set up Node.js  # 使用action库  actions/setup-node安装node
        uses: actions/setup-node@v3
        with:
          node-version: 16 # 根据你的项目需求选择 Node.js 版本

      # 安装依赖
      - name: npm install 
        run: npm install 
    

      # 构建 VuePress 项目，并将workflow拷贝到dist中用于仓库同步到gitee
      - name: Build VuePress
        run: npm run docs:build

      # 复制同步工作流syncToGitee 到 dist
      - name: Copy .github to dist
        run: |
          mkdir -p ./docs/.vuepress/dist/.github/workflows
          cp ./.github/workflows/syncToGitee.yml ./docs/.vuepress/dist/.github/workflows/

      # 部署到 GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN  }} # 在github生成PERSONAL_ACCESS_TOKEN
          publish_dir: ./docs/.vuepress/dist # VuePress 默认的输出目录
          publish_branch: cy-pages # 部署到的目标分支
          exclude_assets: ""


#      #部署到服务器
#      - name: Deploy to Staging My server
#        uses: easingthemes/ssh-deploy@v2.1.6
#        env:
#          # 使用GitHub仓库里的secret设置的值
#          SSH_PRIVATE_KEY: ${{ secrets.MY_SERVER_PRIVATE_KEY }} 
#          # 源目录，编译后生成的文件目录
#          SOURCE: './docs/.vuepress/dist/'
#          #服务器公网地址
#          REMOTE_HOST: ${{ secrets.MY_SERVER_IP }}
#          #服务器用户名-一般默认root
#          REMOTE_USER: 'root'
#          #服务器中，代码部署的位置
#          TARGET: '/opt/myblog'
#          #去除的文件
#          EXCLUDE: "/dist/, /node_modules/" 
```

这里简单说明下文件的内容

- 第一行：本次workflow的名字，可自行更换
- 第 3~6 行：说明只有当 pages-code分支有提交到远程库（push）的时候，执行本次workflow
- 第 8 行：jobs，本次我们只用了一个 job，也就是第 9 行的 job
- 第 10 行：指定要在哪个操作系统的环境下编译出包（一般是 Linux）
- 接下来就是 deploy 这个 job 的 steps，每个 step 做了不同的事情，例如安装 node，然后安装依赖和执行构建命令
- 第 31 行开始就是一些环境变量的设置，例如读取我们上一小节设置的 IP 和私钥信息

注意：

- 因为workflow需要放在对应分支下才能被触发，pages-code分支触发事件push时，GitHub Actions 会检查该分支当前提交中是否存在对应的 YAML 文件，才会执行，所以需要把syncToGitee.yml文件复制到 dist目录

- github_token：

  1. 生成个人访问令牌 (PAT)：
     - 在GitHub的 **Settings > Developer settings > Personal access tokens**->token classic。
     - 创建一个新的 token (classic)，确保选中了 `repo` 和 `workflow` 权限。
     - 复制生成的令牌。
  2. 将 token 添加到 Secrets：
     - 在你的 GitHub 仓库中，进入 **Settings > Secrets and variables > Actions**。
     - 添加一个新的 Repository Secret，名称为 `PERSONAL_ACCESS_TOKEN`，值为刚刚生成的 PAT。

- publish_dir: 就是你要复制到目标分支cy-pages的目录

- exclude_assets: 指定哪些文件或目录不推送到目标分支，exclude_assets的值默认有**`.github`**



## 优化自动部署



每次等待构建并部署都需要等2分钟甚至更久，这是因为每次执行workflow都需要重新搭建环境`npm install`，GitHub Action 提供了缓存机制，可以不用每次都搭建环境。修改deploy.yml文件

```yml
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # ...
      
      # 添加缓存 
      # 缓存 node_modules
      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      # 安装依赖（仅在缓存未命中时执行）
      - name: npm install 
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm install 
    
	  # ...
	  
```

```
解释（由于带${{ }}部署项目时会被node解析，所以写在代码块里）
path: node_modules 
	表示要缓存项目的 node_modules 文件夹
key: node-modules-${{ runner.os }}-${{ hashFiles('\**/package-lock.json') }}
	node-modules-: 这是一个固定的前缀，用来标识缓存的内容是 `node_modules`。
	${{ runner.os }}: 表示当前运行的操作系统（如 `ubuntu-latest`, `windows-latest`, `macos-latest`）。
	${{ hashFiles('**/package-lock.json') }}: 基于 `package-lock.json` 文件的内容生成一个哈希值。如果 `package-lock.json 发生变化（例如添加或更新依赖），哈希值也会变化，从而触发新的缓存。
	
restore-keys: | 
	node-modules-${{ runner.os }}-
	作用： 提供一组备用的缓存键（`restore-keys`），用于在主键（key）未命中时尝试部分匹配。
	分解解释：
		|：YAML 的多行字符串语法，表示后面的每一行是一个独立的 restore-key。
		node-modules-${{ runner.os }}-: 这是一个“模糊匹配”的键，只包含固定前缀和操作系统信息，而不包含 `package-lock.json 的哈希值。如果主键（key）未命中，GitHub Actions 会依次尝试包含这些前缀的缓存：
```

可以看到workflow的运行时间，因为命中缓存跳过了执行`npm install`的40秒

这样deploy.sh脚本就没用了





